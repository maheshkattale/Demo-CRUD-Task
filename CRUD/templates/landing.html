{% load static %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mahesh Kattale – Admin Demo</title>
    <link rel="icon" href="{% static 'images/mahesh-icon.png' %}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'assets/css/landing.css' %}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">

            </a>
            <span class="navbar-text small">
                <div><i class="fa fa-user-shield me-2"></i>
                Developed by <strong>Mahesh Kattale</strong></div>
                <div>
                    <i class="fa fa-phone me-2"></i>
                Contact <strong>7776008548</strong>
                </div>
                <div>
                    <i class="fa fa-envelope me-2"></i>
                Email <strong>maheshkattale1926@gmail.com</strong>
                </div>
            </span>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">Users</h2>
                <div class="small-muted">Manage user records CRUD</div>
            </div>
            <div>
                <button id="btnAdd" class="btn btn-primary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#userModal">
                    <i class="fa fa-plus me-2"></i> Add User
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="usersTable" class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Email</th>
                                <th>Age</th>
                                <th>Qualification</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <h2 class="mb-4">Third Party Data</h2>
        <div class="row third-party-div">
            {% for item in third_party_data %}
            
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <span class="badge bg-gradient-header text-white mb-2">External Data</span>
                        <h5 class="card-title">{{ item.title|truncatewords:8 }}</h5>
                        <p class="card-text small text-muted">{{ item.body|truncatewords:20 }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <footer class="text-center py-3 mt-5">
        <div class="small text-muted">
            © 2025 Developed by <strong>Mahesh Kattale</strong>
        </div>
    </footer>

    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="userForm" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Add User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" id="userId" name="id">

                        <div class="mb-3">
                            <label for="name" class="form-label required">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                placeholder="e.g., ABC XYZ" required maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="mobile_number" class="form-label required">Mobile Number</label>
                            <input type="text" class="form-control" id="mobile_number" name="mobile_number"
                                placeholder="10-digit or +91..." required maxlength="15">
                            <div class="form-text">Only digits, spaces, + and - are allowed.</div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email (optional)</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="abc@example.com">
                            <div class="form-text">Must be a valid email address.</div>
                        </div>

                        <div class="mb-3">
                            <label for="age" class="form-label required">Age</label>
                            <input type="number" class="form-control" id="age" name="age" required min="0" max="120">
                        </div>

                        <div class="mb-3">
                            <label for="qualification" class="form-label">Qualification</label>
                            <input type="text" class="form-control" id="qualification" name="qualification"
                                maxlength="100" placeholder="e.g., B.Tech, MBA">
                        </div>

                        <div id="formAlert" class="alert d-none" role="alert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="userDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <i class="fa fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <h5>Delete this user?</h5>
                    <div class="small text-muted mb-3">This action cannot be undone.</div>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script>
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        const API_BASE = '/api/user/';
        let editingId = null;

        function showAlert(message, type = 'success') {
            const el = $('#formAlert');
            el.removeClass('d-none alert-success alert-danger alert-warning').addClass('alert-' + (type === 'error' ? 'danger' : type));
            el.text(message);
        }
        
        function clearAlert() {
            $('#formAlert').addClass('d-none').text('');
        }
        function rowHtml(item, idx) {
            return `
        <tr data-id="${item.id}">
          <td>${idx}</td>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.mobile_number)}</td>
          <td>${escapeHtml(item.email || '')}</td>
          <td>${item.age}</td>
          <td>${escapeHtml(item.qualification || '')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary m-1 viewBtn" title="View"><i class="fa fa-eye"></i></button>
            <button class="btn btn-sm btn-outline-secondary m-1 editBtn" title="Edit"><i class="fa fa-pen"></i></button>
            <button class="btn btn-sm btn-outline-danger m-1 deleteBtn" title="Delete"><i class="fa fa-trash"></i></button>
          </td>
        </tr>
      `;
        }
        function escapeHtml(text) {
            return $('<div/>').text(text).html();
        }
        
        function loadUsers() {
            $.get(API_BASE + 'user-list-api', function (response) {
                const tbody = $('#usersTable tbody').empty();
                if (response.data.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center text-muted py-4">No users found.</td></tr>');
                    return;
                } else {
                    response.data.forEach((item, i) => tbody.append(rowHtml(item, i + 1)));
                }
            }).fail(function () {
                console.error('Failed to load users');
            });
        }

        $(function () {
            loadUsers();
            
            $('#btnAdd').on('click', function () {
                editingId = null;
                $('#modalTitle').text('Add User');
                $('#userForm')[0].reset();
                clearAlert();
            });

            $('#usersTable').on('click', '.editBtn', function () {
                const tr = $(this).closest('tr');
                const id = tr.data('id');
                editingId = id;
                $('#modalTitle').text('Edit User');
                clearAlert();
                $.get(API_BASE + 'get-user-detail/' + id, function (response) {
                    if (response.data) {
                        $('#userId').val(response.data.id);
                        $('#name').val(response.data.name);
                        $('#mobile_number').val(response.data.mobile_number);
                        $('#email').val(response.data.email);
                        $('#age').val(response.data.age);
                        $('#qualification').val(response.data.qualification);
                    } else {
                        showAlert('User not found', 'error');
                    }
                    var modal = new bootstrap.Modal(document.getElementById('userModal'));
                    modal.show();
                }).fail(function () { showAlert('Could not load user', 'error'); });
            });

            $('#usersTable').on('click', '.viewBtn', function () {
                const tr = $(this).closest('tr');
                const id = tr.data('id');
                $.get(API_BASE + 'get-user-detail/' + id, function (response) {
                    if (response.data) {
                        let user = response.data;
                        let detailsHtml = `
                            <p><strong>Name:</strong> ${escapeHtml(user.name)}</p>
                            <p><strong>Mobile Number:</strong> ${escapeHtml(user.mobile_number)}</p>
                            <p><strong>Email:</strong> ${escapeHtml(user.email || 'N/A')}</p>
                            <p><strong>Age:</strong> ${user.age}</p>
                            <p><strong>Qualification:</strong> ${escapeHtml(user.qualification || 'N/A')}</p>
                            `;
                        $('#viewUserModal .modal-title').text('User Details');
                        $('#viewUserModal .modal-body').html(detailsHtml);
                        $('#viewUserModal .modal-footer').hide();
                    } else {
                        showAlert('User not found', 'error');
                    }
                    var modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                    modal.show();
                }).fail(function () { showAlert('Could not load user', 'error'); });
            });

            let deleteTargetId = null;
            $('#usersTable').on('click', '.deleteBtn', function () {
                const tr = $(this).closest('tr');
                deleteTargetId = tr.data('id');
                var delModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                delModal.show();
            });

            $('#confirmDeleteBtn').on('click', function () {
                if (!deleteTargetId) return;
                $.ajax({
                    url: API_BASE + 'delete-user/' + deleteTargetId,
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrftoken },
                    success: function () {
                        loadUsers();
                        deleteTargetId = null;
                        var delModalEl = document.getElementById('confirmDeleteModal');
                        var delModal = bootstrap.Modal.getInstance(delModalEl);
                        delModal.hide();
                    },
                    error: function (xhr) {
                        alert('Delete failed: ' + xhr.statusText);
                    }
                });
            });

            
            $.validator.addMethod('regex', function (value, element, regexp) {
                if (this.optional(element)) return true;
                var re = (typeof regexp === 'string') ? new RegExp(regexp) : regexp;
                return re.test(value);
            }, 'Invalid format');

            $('#userForm').validate({
                rules: {
                    name: { required: true, maxlength: 100 },
                    mobile_number: { required: true, maxlength: 15, minlength: 7, regex: /^[+\d][\d\s\-]+$/ },
                    email: { maxlength: 100, regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                    age: { required: true, number: true, min: 0, max: 120 },
                    qualification: { maxlength: 100 }
                },
                messages: {
                    name: { required: "Please enter full name" },
                    mobile_number: { required: "Please enter mobile number", minlength: "Too short" },
                    age: { required: "Please enter age" }
                },
                errorClass: 'text-danger small',
                errorPlacement: function (error, element) {
                    error.insertAfter(element);
                },
                submitHandler: function (form) {
                    const payload = {
                        name: $('#name').val().trim(),
                        mobile_number: $('#mobile_number').val().trim(),
                        email: $('#email').val().trim() || null,
                        age: parseInt($('#age').val(), 10),
                        qualification: $('#qualification').val().trim() || null
                    };
                    let method = editingId ? 'PUT' : 'POST';
                    console.log('Payload:', payload, 'Method:', method, 'EditingId:', editingId);

                    let url = API_BASE + (editingId ? 'edit-user/' + editingId : 'add-user');
                    $.ajax({
                        url: url,
                        method: method,
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        headers: { 'X-CSRFToken': csrftoken },
                        success: function (response) {
                            if (response.response.n == 1) {
                                showAlert('User saved successfully', 'success');
                                loadUsers();
                                var modalEl = document.getElementById('userModal');
                                var modal = bootstrap.Modal.getInstance(modalEl);
                                modal.hide();
                            } else {
                                showAlert('Error: ' + (response.response.msg || 'Unknown error'), 'error');
                                return;
                            }
                        },
                        error: function (xhr) {
                            const resp = xhr.responseJSON || {};
                            const errMsg = resp.detail || JSON.stringify(resp);
                            showAlert('Error saving user: ' + errMsg, 'error');
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>