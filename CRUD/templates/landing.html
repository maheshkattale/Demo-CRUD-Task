{% load static %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Users â€” Admin</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Professional but subtle custom styles */
        body {
            background: #f6f8fb;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(20, 30, 60, 0.06);
        }

        .table thead th {
            border-bottom: 0;
        }

        .btn-primary {
            background-image: linear-gradient(135deg, #4f46e5, #06b6d4);
            border: none;
        }

        .form-label.required:after {
            content: " *";
            color: #dc3545;
        }

        .small-muted {
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">Users</h2>
                <div class="small-muted">Manage user records CRUD</div>
            </div>
            <div>
                <button id="btnAdd" class="btn btn-primary shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#userModal">
                    <i class="fa fa-plus me-2"></i> Add User
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="usersTable" class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Mobile</th>
                                <th>Age</th>
                                <th>Qualification</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add / Edit User -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="userForm" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Add User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" id="userId" name="id">

                        <div class="mb-3">
                            <label for="name" class="form-label required">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                placeholder="e.g., Mahesh Kattale" required maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="mobile_number" class="form-label required">Mobile Number</label>
                            <input type="text" class="form-control" id="mobile_number" name="mobile_number"
                                placeholder="10-digit or +91..." required maxlength="15">
                            <div class="form-text">Only digits, spaces, + and - are allowed.</div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email (optional)</label>
                            <input type="email" class="form-control" id="email" name="email"
                                placeholder="e.g.,">
                            <div class="form-text">Must be a valid email address.</div>
                        </div>

                        <div class="mb-3">
                            <label for="age" class="form-label required">Age</label>
                            <input type="number" class="form-control" id="age" name="age" required min="0" max="120">
                        </div>

                        <div class="mb-3">
                            <label for="qualification" class="form-label">Qualification</label>
                            <input type="text" class="form-control" id="qualification" name="qualification"
                                maxlength="100" placeholder="e.g., B.Tech, MBA">
                        </div>

                        <div id="formAlert" class="alert d-none" role="alert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <i class="fa fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <h5>Delete this user?</h5>
                    <div class="small text-muted mb-3">This action cannot be undone.</div>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery Validation plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script>
        // CSRF setup for AJAX (Django)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Base API URL - adjust if your API root differs
        const API_BASE = '/api/user/';
        let editingId = null;

        // Helpers
        function showAlert(message, type = 'success') {
            const el = $('#formAlert');
            el.removeClass('d-none alert-success alert-danger alert-warning').addClass('alert-' + (type === 'error' ? 'danger' : type));
            el.text(message);
        }

        function clearAlert() {
            $('#formAlert').addClass('d-none').text('');
        }

        function rowHtml(item, idx) {
            return `
                <tr data-id="${item.id}">
                <td>${idx}</td>
                <td>${escapeHtml(item.name)}</td>
                <td>${escapeHtml(item.mobile_number)}</td>
                <td>${item.age}</td>
                <td>${escapeHtml(item.qualification || '')}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-light me-1 editBtn" title="Edit"><i class="fa fa-pen"></i></button>
                    <button class="btn btn-sm btn-outline-danger deleteBtn" title="Delete"><i class="fa fa-trash"></i></button>
                </td>
                </tr>
            `;
        }

        function escapeHtml(text) {
            return $('<div/>').text(text).html();
        }

        // Load all users
        function loadUsers() {
            $.get(API_BASE+'user-list-api', function (response) {
                const tbody = $('#usersTable tbody').empty();
                console.log(response.data);
                if (response.data.length === 0) {
                    tbody.append('<tr><td colspan="6" class="text-center text-muted py-4">No users found.</td></tr>');
                    return;
                }else{
                    response.data.forEach((item, i) => tbody.append(rowHtml(item, i + 1)));

                }
            }).fail(function () {
                console.error('Failed to load users');
            });
        }

        $(function () {
            loadUsers();

            // Open Add modal
            $('#btnAdd').on('click', function () {
                editingId = null;
                $('#modalTitle').text('Add User');
                $('#userForm')[0].reset();
                clearAlert();
            });

            // Delegate Edit button
            $('#usersTable').on('click', '.editBtn', function () {
                const tr = $(this).closest('tr');
                const id = tr.data('id');
                editingId = id;
                $('#modalTitle').text('Edit User');
                clearAlert();
                // Fetch single user
                $.get(API_BASE + id + '/', function (data) {
                    $('#userId').val(data.id);
                    $('#name').val(data.name);
                    $('#mobile_number').val(data.mobile_number);
                    $('#age').val(data.age);
                    $('#qualification').val(data.qualification);
                    var modal = new bootstrap.Modal(document.getElementById('userModal'));
                    modal.show();
                }).fail(function () { showAlert('Could not load user', 'error'); });
            });

            // Delegate Delete button
            let deleteTargetId = null;
            $('#usersTable').on('click', '.deleteBtn', function () {
                const tr = $(this).closest('tr');
                deleteTargetId = tr.data('id');
                var delModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                delModal.show();
            });

            $('#confirmDeleteBtn').on('click', function () {
                if (!deleteTargetId) return;
                $.ajax({
                    url: API_BASE + deleteTargetId + '/',
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrftoken },
                    success: function () {
                        loadUsers();
                        deleteTargetId = null;
                        var delModalEl = document.getElementById('confirmDeleteModal');
                        var delModal = bootstrap.Modal.getInstance(delModalEl);
                        delModal.hide();
                    },
                    error: function (xhr) {
                        alert('Delete failed: ' + xhr.statusText);
                    }
                });
            });

            // jQuery validation rules
            $('#userForm').validate({
                rules: {
                    name: { required: true, maxlength: 100 },
                    mobile_number: { required: true, maxlength: 15, minlength: 7, regex: /^[+\d][\d\s\-]+$/ },
                    age: { required: true, number: true, min: 0, max: 120 },
                    qualification: { maxlength: 100 }
                },
                messages: {
                    name: { required: "Please enter full name" },
                    mobile_number: { required: "Please enter mobile number", minlength: "Too short" },
                    age: { required: "Please enter age" }
                },
                errorClass: 'text-danger small',
                errorPlacement: function (error, element) {
                    error.insertAfter(element);
                },
                submitHandler: function (form) {
                    // gather data
                    const payload = {
                        name: $('#name').val().trim(),
                        mobile_number: $('#mobile_number').val().trim(),
                        age: parseInt($('#age').val(), 10),
                        qualification: $('#qualification').val().trim() || null
                    };

                    let method = editingId ? 'PUT' : 'POST';
                    let url = API_BASE+'add-user' + (editingId ? editingId + '/' : '');
                    debugger
                    console.log('Submitting', method, url, payload);
                    $.ajax({
                        url: url,
                        method: method,
                        contentType: 'application/json',
                        data: JSON.stringify(payload),
                        headers: { 'X-CSRFToken': csrftoken },
                        success: function (response) {
                            if (response.response.n==1) {
                                showAlert('User saved successfully', 'success');
                                loadUsers();
                                var modalEl = document.getElementById('userModal');
                                var modal = bootstrap.Modal.getInstance(modalEl);
                                modal.hide();
                            } else {
                                showAlert('Error: ' + (response.response.msg || 'Unknown error'), 'error');
                                return;
                            }
                            
                        },
                        error: function (xhr) {
                            const resp = xhr.responseJSON || {};
                            const errMsg = resp.detail || JSON.stringify(resp);
                            showAlert('Error saving user: ' + errMsg, 'error');
                        }
                    });
                }
            });

            // add custom regex method
            $.validator.addMethod('regex', function (value, element, regexp) {
                if (this.optional(element)) return true;
                var re = (typeof regexp === 'string') ? new RegExp(regexp) : regexp;
                return re.test(value);
            }, 'Invalid format');

        });
    </script>
</body>

</html>